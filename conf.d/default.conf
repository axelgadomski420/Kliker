upstream ai_clicker {
    server ad-mine-clicker:5000;
}

server {
    listen 80;
    server_name _;

    # Serve static files or proxy to AI clicker
    location / {
        try_files $uri $uri/ @proxy;
    }

    location @proxy {
        access_by_lua_block {
            ngx.shared.ads:incr("imps", 1)
        }
        proxy_pass http://ai_clicker/scan;
    }

    # Endpoint to trigger click burst
    location /api/click {
        access_by_lua_block {
            ngx.shared.ads:incr("clicks", 1)
        }
        proxy_pass http://ai_clicker/scan;
    }

    # Stats endpoint for dashboard
    location /stats {
        content_by_lua_block {
            local ads = ngx.shared.ads
            ngx.header.content_type = "application/json"
            ngx.say(string.format('{"imps":%d,"clicks":%d}', ads:get("imps"), ads:get("clicks")))
        }
    }

    # Health check for Render
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # Error pages
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    location = /404.html {
        root /usr/share/nginx/html;
        internal;
    }

    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }
}
