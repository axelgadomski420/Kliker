<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ad Mining Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; margin:0; padding:20px;
           display:flex; flex-direction:column; align-items:center; }
    h1 { color:#333; margin-bottom:20px; }
    .stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
             gap:20px; width:100%; max-width:800px; margin-bottom:30px; }
    .card { background:#fff; padding:20px; border-radius:8px;
             box-shadow:0 2px 8px rgba(0,0,0,0.1); text-align:center; }
    .card h2 { margin:0 0 10px; font-size:2.2em; color:#007bff; }
    .card p { margin:0; color:#555; font-size:0.9em; }
    button { padding:12px 24px; border:none; border-radius:6px; background:#28a745;
             color:#fff; font-size:1em; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1);
             transition:background 0.2s; margin-top:10px; }
    button:hover { background:#218838; }
    #msg { margin-top:15px; color:#28a745; font-weight:bold; }
    .control-panel { max-width:800px; width:100%; background:#fff; border-radius:8px;
                     padding:15px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px; }
    #chatWindow { background:#f9f9f9; border:1px solid #ddd; border-radius:6px;
                  max-height:200px; overflow-y:auto; padding:10px; font-size:0.9em;
                  line-height:1.4; }
    #commandInput { width:100%; max-width:800px; height:60px; margin-top:10px;
                    padding:8px; font-size:1em; border:1px solid #ccc; border-radius:4px;
                    resize:vertical; min-height:50px; }
    #commandResponse { display:none; }
    .confetti { position:fixed; width:100%; height:100%; top:0; left:0;
                pointer-events:none; overflow:hidden; z-index:9999; }
    .confetti-piece { position:absolute; width:10px; height:6px; background-color:red;
                      opacity:0.8; transform-origin:center; animation:fall 3s linear forwards; }
    @keyframes fall {
      to { transform:translate(var(--dx),100vh) rotate(var(--rot)); opacity:0; }
    }
  </style>
</head>
<body>
  <h1>Ad Mining Platform</h1>

  <div class="stats">
    <div class="card"><h2 id="imps">0</h2><p>Impressions</p></div>
    <div class="card"><h2 id="clicks">0</h2><p>Clicks</p></div>
    <div class="card"><h2 id="ctr">0%</h2><p>CTR</p></div>
    <div class="card"><h2>$<span id="revenue">0.00</span></h2><p>Revenue</p></div>
  </div>

  <button onclick="manualScan()">Magnes na reklamy</button>

  <div class="control-panel">
    <h3>Sterowanie AI Face App</h3>
    <div id="chatWindow"></div>
    <textarea id="commandInput" placeholder="Wpisz komendę…"></textarea><br>
    <button onclick="sendCommand()">Wyślij</button>
  </div>

  <div id="msg"></div>
  <div id="confetti" class="confetti"></div>

  <script>
    let clickCount = 0;

    function appendMessage(who, msg) {
      const win = document.getElementById("chatWindow");
      const line = document.createElement("div");
      line.style.marginBottom = "6px";
      line.innerHTML = `<strong>${who}:</strong> ${msg}`;
      win.appendChild(line);
      win.scrollTop = win.scrollHeight;
    }

    function launchConfetti() {
      const container = document.getElementById("confetti");
      for (let i = 0; i < 100; i++) {
        const piece = document.createElement("div");
        piece.classList.add("confetti-piece");
        piece.style.backgroundColor = `hsl(${Math.random()*360},70%,60%)`;
        piece.style.left = `${Math.random()*100}%`;
        piece.style.setProperty("--dx", (Math.random()*200-100) + "px");
        piece.style.setProperty("--rot", (Math.random()*360) + "deg");
        piece.style.animationDelay = (Math.random()*2) + "s";
        container.appendChild(piece);
        setTimeout(() => piece.remove(), 3000);
      }
    }

    async function manualScan() {
      await fetch("/scan", { method: "POST" });
      clickCount++;
      if (clickCount % 3 === 0) launchConfetti();
      document.getElementById("msg").innerText = "Magnes uruchomiony!";
      setTimeout(() => { document.getElementById("msg").innerText = ""; }, 3000);
      fetchStats();
    }

    async function fetchStats() {
      try {
        const res = await fetch("/stats");
        const data = await res.json();
        document.getElementById("imps").innerText = data.imps;
        document.getElementById("clicks").innerText = data.clicks;
        document.getElementById("ctr").innerText = ((data.clicks/data.imps||0)*100).toFixed(2) + "%";
        document.getElementById("revenue").innerText = data.revenue.toFixed(2);
      } catch (e) {
        console.error("Failed to fetch stats:", e);
      }
    }

    async function sendCommand() {
      const inputEl = document.getElementById("commandInput");
      const text = inputEl.value.trim();
      if (!text) return;
      appendMessage("Ty", text);
      inputEl.value = "";
      try {
        const [action, value] = text.split(" ");
        const res = await fetch("/command", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action, value })
        });
        const data = await res.json();
        appendMessage("AI", JSON.stringify(data));
      } catch (e) {
        appendMessage("AI", "Błąd komunikacji");
      }
    }

    setInterval(fetchStats, 5000);
    fetchStats();
  </script>
</body>
</html>
